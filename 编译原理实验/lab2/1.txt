// ï¿½ï¿½ï¿½ï¿½Í·ï¿½Ä¼ï¿½
#include <stdio.h>
#include <stddef.h>
#include <ctype.h>
#include <string.h>

// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
FILE *fp;
char ch; // ï¿½ï¿½Â¼ï¿½ï¿½Ç°ï¿½Ö·ï¿½
int line = 0;
char category[10];
char value[10];

const char *key[13] = {"main", "int", "if", "else", "while", "break", "continue", "float", "void", "const", "printf", "getint", "return"}; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ø¼ï¿½ï¿½ï¿½
const char *key_name[13] = {"MAINTK", "INTCON", "IFTK", "ELSETK", "WHILETK", "BREAKTK", "CONTINUETK", "FLOATCON", "VOIDTK", "CONSTTK", "PRINTFTK", "GETINTTK", "RETURNTK"};
const char *other_table[11] = {",", ";", "(", ")", "[", "]", "{", "}", "!", "||", "&&"}; // ï¿½ï¿½ï¿½ï¿½ï¿½Ö·ï¿½
const char *other_name[11] = {"COMMA", "SEMICN", "LPARENT", "RPARENT", "LBRACK", "RBRACK", "LBRACE", "RBRACE", "NOT", "OR", "AND"};
const char *maths_calcu_table[4] = {"+", "-", "*", "/"}; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
const char *maths_calcu_name[4] = {"PLUS", "MINU", "MULT", "DIV"};
const char *relation_calcu_table[7] = {"<", "<=", ">", ">=", "=", "!=", "=="}; // ï¿½ï¿½ï¿½ï¿½ï¿½Ïµï¿½ï¿?
const char *relation_calcu_name[7] = {"LSS", "LEQ", "GRE", "GEQ", "ASSIGN", "NEQ", "EQL"};

// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
char alphaprocess(char buffer);
int search(char searchchar[]);
char numberprocess(char buffer);
char otherprocess(char buffer);
char relation_calcuProcess(char buffer);
char maths_calcuProcess(char buffer);
char stringprocess(char buffer);

bool isrelation_calcu(char buffer);
bool ismaths_calcu(char buffer);
bool isnumber(char buffer);
bool isalpha(char buffer);
bool isstring(char buffer);
bool isother(char buffer);

void output();
void ERROR(char *s);

int main()
{
    if ((fp = fopen("test.txt", "r")) == NULL)
        printf("error");
    else
    {
        ch = fgetc(fp); // ï¿½ï¿½Ö¸ï¿½ï¿½ï¿½ï¿½ï¿½Ä¼ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½È¡Ò»ï¿½ï¿½ï¿½Ö·ï¿½
        while (ch != EOF)
        {
            if (ch == ' ' || ch == '\n' || ch == '\t')
            { // ï¿½ï¿½ï¿½Ô¿Õ¸ï¿½ï¿½Æ±ï¿½ï¿½ï¿½(ï¿½Â¼ï¿½)ï¿½Í»ï¿½ï¿½Ð·ï¿½
                if (ch == '\n')
                    line++;
                ch = fgetc(fp);
            }
            else if (isstring(ch)) // ï¿½ï¿½ï¿½ï¿½ï¿½Ö·ï¿½ï¿½ï¿½
                ch = stringprocess(ch);
            else if (isalpha(ch)) // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¶ï¿½ï¿½ï¿½Í¹Ø¼ï¿½ï¿½ï¿½
                ch = alphaprocess(ch);
            else if (isnumber(ch)) // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
                ch = numberprocess(ch);
            else if (isother(ch))
                ch = otherprocess(ch);
            else if (isrelation_calcu(ch)) // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ïµï¿½ï¿½ï¿½ï¿½ï¿?
                ch = relation_calcuProcess(ch);
            else if (ismaths_calcu(ch)) // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿?
                ch = maths_calcuProcess(ch);
            else
            {
                ERROR(&ch);
                ch = fgetc(fp);
            }
        }
    }
    fclose(fp); //
    return 0;
}

void ERROR(char *s)
{
    printf("ERROR '%s' in line %d\n", s, line);
}

void output()
{
    printf("(%s,%s)\n", category, value);
}

bool isstring(char buffer) // ï¿½ï¿½Ò»ï¿½ï¿½ï¿½Ö·ï¿½ï¿½ï¿½Ë«ï¿½ï¿½ï¿½Å£ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½Îªï¿½Ö·ï¿½ï¿½ï¿½
{
    if (buffer == 34)
        return true;
    return false;
}

char stringprocess(char buffer)
{
    int i = 0;
    value[i] = buffer;
    buffer = fgetc(fp);
    i++;
    while (!isstring(buffer))
    {
        value[i] = buffer;
        buffer = fgetc(fp);
        i++;
    }
    value[i] = buffer;
    buffer = fgetc(fp);
    i++;
    value[i] = '\0';
    strcpy(category, "STRCON");
    output();
    return buffer;
}

bool isalpha(char buffer)
{
    if ((buffer >= 'a' && buffer <= 'z') || (buffer >= 'A' && buffer <= 'Z') || buffer == '_')
        return true;
    return false;
}

// ï¿½ï¿½ï¿½ï¿½ï¿½Ô¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¹Ø¼ï¿½ï¿½ï¿?
char alphaprocess(char buffer)
{
    int atype; // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ðµï¿½Î»ï¿½ï¿½
    int i = 0;
    while (isalpha(buffer) || isnumber(buffer))
    {
        value[i] = buffer;
        buffer = fgetc(fp);
        i++;
    }
    value[i] = '\0';
    atype = search(value);
    if (atype != 0) // ï¿½Ø¼ï¿½ï¿½ï¿½
    {
        strcpy(category, key_name[atype]);
    }
    else // ï¿½ï¿½ï¿½ï¿½
    {
        strcpy(category, "IDENFR");
    }
    output();
    return buffer; // ï¿½ï¿½ï¿½ï¿½bufferÖµ
}

int search(char searchchar[])
{
    int i;
    int p;
    for (i = 0; i < 13; i++)
    {
        if (strcmp(key[i], searchchar) == 0)
        {
            p = i;
            break;
        }
        else
            p = 0;
    }
    return p;
}

bool isnumber(char buffer)
{
    if (buffer >= '0' && buffer <= '9')
        return true;
    return false;
}

// Ê¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¡ï¿½ï¿½ï¿½ï¿½Êµï¿½ï¿½
char numberprocess(char buffer)
{
    strcpy(category, "NUM");
    int i = 0, flag = 0;
    while (isnumber(buffer) || buffer == '.' || buffer == 'e' || buffer == 'E' || buffer == '+' || buffer == '-')
    {
        if (buffer == 'e' || buffer == 'E') // ï¿½ï¿½Ñ§ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
        {
            flag = 1;
            value[i] = buffer;
        }
        else if (buffer == '+' || buffer == '-')
        {
            if (flag == 1)
            {
                value[i] = buffer;
            }
            else
                break;
        }
        else
        {
            value[i] = buffer;
        }
        buffer = fgetc(fp);
        i++;
    }
    value[i] = '\0';
    output();
    return buffer;
}

bool isother(char buffer)
{
    if (buffer == '&' || buffer == '|' || buffer == ';' || buffer == ',' || buffer == '(' || buffer == ')' || buffer == '{' || buffer == '}' || buffer == '[' || buffer == ']')
        return true;
    return false;
}

// ï¿½ï¿½ï¿½ï¿½ï¿½Ê¶ï¿½ï¿?
char otherprocess(char buffer)
{
    int i = 0;
    while (isother(buffer))
    {
        if (buffer == '(' || buffer == ')' || buffer == '{' || buffer == '}' || buffer == '[' || buffer == ']')
        {
            value[i] = buffer;
            buffer = fgetc(fp);
            i++;
            break;
        }
        value[i] = buffer;
        buffer = fgetc(fp);
        i++;
    }
    value[i] = '\0';

    for (i = 0; i < 11; i++)
    {
        if (strcmp(value, other_table[i]) == 0)
        {
            strcpy(category, other_name[i]);
            output();
            return buffer;
        }
    }
    ERROR(value);
    return buffer;
}

bool isrelation_calcu(char buffer) // ï¿½ï¿½Ïµï¿½ï¿½ï¿½ï¿½ï¿?
{
    if (buffer == '>' || buffer == '<' || buffer == '=' || buffer == '!')
        return true;
    return false;
}

char relation_calcuProcess(char buffer)
{
    int i = 0;
    int flag = 0;
    while ((isrelation_calcu(buffer)))
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æ¶¼ï¿½Ç¹ï¿½Ïµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»Ö±ï¿½ï¿½ï¿½ë£¬Ö±ï¿½ï¿½ï¿½ï¿½ï¿½æ²»ï¿½Ç¹ï¿½Ïµï¿½ï¿½ï¿½ï¿½ï¿½ÎªÖ?
        value[i] = buffer;
        i++;
        buffer = fgetc(fp);
    }
    value[i] = '\0';

    if (value[0] == '!' && value[1] == '\0')
    { // ï¿½ï¿½È·Ê¶ï¿½ð¡°£ï¿½ï¿½ï¿½ï¿½ë¡°ï¿½ï¿½=ï¿½ï¿½
        strcpy(category, "NOT");
        output();
        return buffer;
    }

    // ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½È·
    for (i = 0; i < 7; i++)
    {
        if (strcmp(value, relation_calcu_table[i]) == 0)
        {
            strcpy(category, relation_calcu_name[i]);
            output();
            return buffer;
        }
    }
    ERROR(value);
    return buffer;
}

bool ismaths_calcu(char buffer)
{
    if (buffer == '+' || buffer == '-' || buffer == '*' || buffer == '/')
        return true;
    return false;
}

char maths_calcuProcess(char buffer)
{
    int i = 0;
    while ((ismaths_calcu(buffer)))
    {
        // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½æ¶¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ò»Ö±ï¿½ï¿½ï¿½ë£¬Ö±ï¿½ï¿½ï¿½ï¿½ï¿½æ²»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ÎªÖ?
        value[i] = buffer;
        i++;
        buffer = fgetc(fp);
    }
    value[i] = '\0';

    // ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½×¢ï¿½ï¿?
    bool flag1 = false; // ×¢ï¿½Í¡ï¿½//ï¿½ï¿½
    bool flag2 = false; // ×¢ï¿½Í¡ï¿½/**/ï¿½ï¿½

    if (value[0] == '/' && value[1] == '/')
        flag1 = true;

    if (value[0] == '/' && value[1] == '*')
        flag2 = true;

    if (flag1)
    {
        while (buffer != '\n')
        {
            buffer = fgetc(fp);
        }
        printf("(×¢ï¿½Í£ï¿½_) \n");
        return buffer;
    }

    if (flag2)
    {
        int flag3 = 0;
        while (buffer != '/' && flag3 == 0)
        {
            if (buffer == '\n')
                line++;
            if (buffer == '*')
                flag3 = 1;
            else
                flag3 = 0;
            buffer = fgetc(fp);
        }
        buffer = fgetc(fp);
        printf("(×¢ï¿½Í£ï¿½_) \n");
        return buffer;
    }

    // ï¿½ï¿½ï¿½Ã²ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ï¿½ï¿½Ô¤ï¿½ï¿½Ä·ï¿½ï¿½ï¿½Ö®ï¿½ï¿?
    for (i = 0; i < 4; i++)
    {
        if (strcmp(value, maths_calcu_table[i]) == 0)
        {
            strcpy(category, maths_calcu_name[i]);
            output();
            return buffer;
        }
    }
    ERROR(value);
    return buffer;
}
