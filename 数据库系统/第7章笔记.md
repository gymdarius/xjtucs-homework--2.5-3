# 查询处理与查询优化

## 优化途径的分类

代数优化(独立于存取路径的优化)：对查询语句进行等价变换(改变基本操作的顺序)，使查询语句执行起来更加有效；只涉及查询语句本身，不涉及存取路径。

物理优化(依赖于存取路径的优化)：根据系统提供的查询路径，选择合理的存取策略

规则优化：有些查询可根据启发式规则选择执行策略

代价估算优化：根据可供选择的执行策略进行代价估算，并从中选择代价最小的执行策略

语义优化：通过应用数据库的语义信息对查询进行优化

![image-20240607135127776](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240607135127776.png)

前两个 I/O代价最高。后一个 网络传输代价最高

## 典型题目

PPT上分析 不同查询方式访问物理块数的题目/作业里也是一样的类型

## 代数优化

基本原则是尽量减小查询处理的中间结果大小

投影、选择等一元操作对关系进行水平或垂直分割，减小了关系的大小

并、连接等二元操作对两个关系按条件组合，操作费时且结果集比较大

先安排执行投影、选择，后进行连接、笛卡儿积

**一堆关系代数等价变换规则**

![image-20240609150613095](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609150613095.png)

优化过程：

1. 原始查询树
2. 选择操作尽量下移
3. 投影操作下移
4. 连接条件(选择)和笛卡尔积组合成连接操作

## 物理优化

![image-20240609151336421](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609151336421.png)

### 选择操作的优化、启发式规则

![image-20240609151517804](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609151517804.png)

![image-20240609151534236](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609151534236.png)

### 聚簇索引和非聚簇索引

+ 聚簇索引决定了数据的物理存储顺序，而非聚簇索引不影响数据的物理存储顺序。
+ 聚簇索引的叶节点包含数据行，而非聚簇索引的叶节点包含索引键和指向数据行的指针。
+ 一个表只能有一个聚簇索引，但可以有多个非聚簇索引。
+ 聚簇索引适合范围查询和排序操作，非聚簇索引适合等值查询。
+ 插入或删除数据时，聚簇索引会引起数据行的移动，非聚簇索引不会引起数据行的移动

### 连接操作的优化

![image-20240609152150055](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609152150055.png)

![image-20240609152254840](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609152254840.png)



![image-20240609152428162](C:/Users/lenovo/AppData/Roaming/Typora/typora-user-images/image-20240609152428162.png)

2）的计算代价表达式和1）类似，只不过后半部分有差异，2）中利用索引获得满足连接条件的关系S元组所需要的代价较小。

![image-20240609152741106](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609152741106.png)

使用的前提是两个表均有序。所需要访问的物理块数为两者物理块数之和：b~R~+b~S~

![image-20240609152924829](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609152924829.png)

![image-20240609152930958](https://gitee.com/du-jianyu1012/img/raw/master/picture/image-20240609152930958.png)

**顺序索引就是聚簇索引**

### 投影操作

+ 选取关系的某些列，从垂直的方向减小关系的大小
+ 可与选择、连接操作同时进行
+ 需要消除重复元组
+ 关于第三点：**排序：等值元素相邻/散列方法消除**